<!DOCTYPE html>
<html>
<head>
    <title>My Profile - NOWFit</title>
<link rel="icon" type="image/png" href="/favicon.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <style>
        body { background: #f4f6f9; font-family: Inter, sans-serif; }

        .profile-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            max-width: 850px;
            margin: auto;
        }

        .avatar-box {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #0ea5a4;
            margin-bottom: 15px;
        }

        .avatar-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .section-title {
            margin-top: 40px;
            font-weight: 700;
            font-size: 20px;
            color: #0f172a;
        }

        #toast {
            position: fixed;
            top: 18px;
            right: 18px;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 600;
            color: white;
            display: none;
            z-index: 9999;
        }
    </style>
</head>

<body>

<div id="toast"></div>

<div class="container py-5">

    <div class="profile-card">

        <h2 class="fw-bold mb-3">My Profile</h2>
        <a href="/client/dashboard" class="btn btn-outline-secondary mb-3">‚Üê Back to Dashboard</a>

        <!-- USER INFO -->
        <div class="text-center">
            <div class="avatar-box">
                <img src="<%= user.profileImage || '/images/dummy-avatar.png' %>" alt="Profile">
            </div>
            <h4 class="fw-bold"><%= user.name %></h4>
            <p class="text-muted"><%= user.email %></p>
        </div>

        <hr>

        <!-- UPDATE PROFILE -->
        <h4 class="section-title">Update Profile</h4>

        <form id="profileForm" enctype="multipart/form-data" class="mt-3">
            <div class="mb-3">
                <label>Name</label>
                <input name="name" value="<%= user.name %>" class="form-control">
            </div>

            <div class="mb-3">
                <label>Email</label>
                <input name="email" value="<%= user.email %>" class="form-control">
            </div>

            <div class="mb-3">
                <label>Update Photo</label>
                <input type="file" name="avatar" class="form-control">
            </div>

            <button class="btn btn-primary mt-2">Save Changes</button>
        </form>

        <hr>

        <!-- CHANGE PASSWORD -->
        <h4 class="section-title">Change Password</h4>

        <form id="passwordForm" class="mt-3">
            <div class="mb-3">
                <input name="oldPassword" type="password" placeholder="Old Password" class="form-control" required>
            </div>

            <div class="mb-3">
                <input name="newPassword" type="password" placeholder="New Password" class="form-control" required>
            </div>

            <button class="btn btn-dark">Change Password</button>
        </form>

        <hr>

        <!-- OTP RESET -->
        <h4 class="section-title">Reset Password via OTP</h4>

        <button id="sendOtpBtn" class="btn btn-warning mt-2">Send OTP</button>

        <form id="otpForm" class="mt-3">
            <div class="mb-3">
                <input name="otp" type="text" placeholder="Enter OTP" class="form-control">
            </div>

            <div class="mb-3">
                <input name="newPassword" type="password" placeholder="New Password" class="form-control">
            </div>

            <button class="btn btn-success">Reset Password</button>
        </form>

        <hr>

        <div class="text-end">
            <a href="/auth/logout" class="btn btn-danger">Logout</a>
        </div>

    </div>

</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
function toast(msg, ok = true) {
    $('#toast')
        .text(msg)
        .css('background', ok ? '#10b981' : '#ef4444')
        .fadeIn();

    setTimeout(() => $('#toast').fadeOut(), 1500);
}

// PROFILE UPDATE
$('#profileForm').submit(function(e){
    e.preventDefault();
    const fd = new FormData(this);

    $.ajax({
        url: '/client/profile/update',
        method: 'POST',
        data: fd,
        processData: false,
        contentType: false,
        success: res => {
            toast(res.message, res.success);
            if (res.success) setTimeout(()=> location.reload(), 900);
        }
    });
});

// CHANGE PASSWORD
$('#passwordForm').submit(async function(e){
    e.preventDefault();
    const res = await fetch('/client/profile/change-password', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({
            oldPassword: this.oldPassword.value,
            newPassword: this.newPassword.value
        })
    });

    const json = await res.json();
    toast(json.message, json.success);
});

// SEND OTP
$('#sendOtpBtn').click(async function(){
    const res = await fetch('/client/profile/send-otp', { method: 'POST' });
    const json = await res.json();
    toast(json.message, json.success);
});

// VERIFY OTP
$('#otpForm').submit(async function(e){
    e.preventDefault();

    const res = await fetch('/client/profile/verify-otp', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({
            otp: this.otp.value,
            newPassword: this.newPassword.value
        })
    });

    const json = await res.json();
    toast(json.message, json.success);
});
</script>

</body>
</html>
