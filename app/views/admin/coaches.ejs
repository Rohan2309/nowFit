<!doctype html>
<html>
<head>
  <title>Manage Coaches</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="icon" type="image/png" href="/favicon.png">

  <style>
    body { background: #f5f6fa; }

    .toast-fixed {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 20000;
    }
  </style>
</head>

<body>

<nav class="navbar navbar-light bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/admin/dashboard">NOWFit - Admin</a>
    <a class="btn btn-outline-dark" href="/auth/logout">Logout</a>
  </div>
</nav>

<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">Manage Coaches</h2>
    <a href="/admin/dashboard" class="btn btn-secondary">Back to Dashboard</a>
  </div>

  <!-- COACHES TABLE -->
  <div class="card shadow-sm p-3">
    <table class="table table-striped align-middle">
      <thead class="table-dark">
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th style="width: 200px;">Action</th>
        </tr>
      </thead>

      <tbody>
        <% coaches.forEach(c => { %>
          <tr data-id="<%= c._id %>">
            <td class="cname"><%= c.name %></td>
            <td class="cemail"><%= c.email %></td>

            <td>
              <button class="btn btn-sm btn-primary editCoachBtn">Edit</button>
              <button class="btn btn-sm btn-danger delCoachBtn">Delete</button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>


<!-- ===========================
     EDIT COACH MODAL
=========================== -->
<div class="modal fade" id="editCoachModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="editCoachForm" class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title fw-bold">Edit Coach</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <input type="hidden" id="editCoachId">

        <div class="mb-3">
          <label class="form-label">Name</label>
          <input id="editCoachName" class="form-control" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Email</label>
          <input id="editCoachEmail" type="email" class="form-control" required>
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary">Save Changes</button>
      </div>

    </form>
  </div>
</div>


<!-- TOAST -->
<div class="toast-fixed">
  <div id="toastMsg" class="toast text-bg-success border-0">
    <div class="toast-body" id="toastBody"></div>
  </div>
</div>


<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(function(){

  function showToast(msg, ok = true){
    $("#toastMsg")
      .removeClass("text-bg-success text-bg-danger")
      .addClass(ok ? "text-bg-success" : "text-bg-danger");

    $("#toastBody").text(msg);
    $("#toastMsg").fadeIn();

    setTimeout(() => $("#toastMsg").fadeOut(), 1200);
  }

  /* ========== DELETE COACH ========== */
  $(".delCoachBtn").on("click", async function(){
    if(!confirm("Delete this coach?")) return;

    const tr = $(this).closest("tr");
    const id = tr.data("id");

    const res = await fetch("/admin/coaches/" + id, { method: "DELETE" });
    const json = await res.json();

    if(json.success){
      tr.remove();
      showToast("Coach Deleted");
    } else {
      showToast("Failed!", false);
    }
  });


  /* ========== OPEN EDIT MODAL ========== */
  $(".editCoachBtn").on("click", function(){
    const tr = $(this).closest("tr");

    const id = tr.data("id");
    const name = tr.find(".cname").text().trim();
    const email = tr.find(".cemail").text().trim();

    $("#editCoachId").val(id);
    $("#editCoachName").val(name);
    $("#editCoachEmail").val(email);

    $("#editCoachModal").modal("show");
  });


  /* ========== SUBMIT EDIT ========== */
  $("#editCoachForm").on("submit", async function(e){
    e.preventDefault();

    const id = $("#editCoachId").val();
    const name = $("#editCoachName").val();
    const email = $("#editCoachEmail").val();

    const res = await fetch("/admin/coaches/" + id, {
      method: "PUT",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ name, email })
    });

    const json = await res.json();

    if(json.success){
      const tr = $('tr[data-id="' + id + '"]');

      tr.find(".cname").text(json.coach.name);
      tr.find(".cemail").text(json.coach.email);

      $("#editCoachModal").modal("hide");
      showToast("Updated!");
    } else {
      showToast(json.message || "Failed", false);
    }
  });

});
</script>

</body>
</html>
