<!doctype html>
<html>
<head>
  <title>NOWFit - Admin Dashboard</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="icon" type="image/png" href="/favicon.png">

  <!-- DataTables -->
  <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">

  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --primary:#0ea5a4;
      --accent:#06b6d4;
      --warning:#f59e0b;
      --danger:#ef4444;
      --success:#10b981;
      --gray:#6b7280;
      --card:white;
      --bg:#f3f6f9;
    }

    body{
      background:var(--bg);
      font-family: Inter, "Segoe UI", Roboto, Arial;
    }

    /* NAVBAR */
    .navbar-custom{
      background:white;
      box-shadow:0 4px 16px rgba(0,0,0,0.06);
      padding:16px 0;
    }
    .navbar-brand{
      font-size:26px; font-weight:800; color:#0f172a;
    }
    .logout-btn{
      background:#ef4444;
      color:white;
      font-weight:600;
      padding:8px 20px;
      border-radius:10px;
    }

    /* HEADER */
    h1.page-title{
      font-size:40px;
      font-weight:800;
      color:#0f172a;
    }

    /* CARDS */
    .stat-grid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:18px;
      margin-bottom:30px;
    }
    .stat-card{
      padding:24px;
      border-radius:14px;
      background:white;
      box-shadow:0 6px 15px rgba(0,0,0,0.05);
      transition:0.2s;
    }

    /* BUTTONS */
    .top-btn{
      border-radius:10px;
      padding:10px 18px;
      font-weight:600;
      color:white;
      box-shadow:0 5px 14px rgba(0,0,0,0.08);
    }
    .btn-coach{ background:var(--accent); }
    .btn-workout{ background:var(--primary); }
    .btn-diet{ background:var(--warning); color:#111; }
    .btn-profile{ background:#111; }
    .btn-create{
      background:#10b981;
      padding:12px 22px;
      font-size:16px;
      color:white;
    }

    /* TABLE CARD */
    .table-card{
      background:white;
      padding:20px;
      border-radius:14px;
      box-shadow:0 8px 20px rgba(0,0,0,0.05);
    }

    /* TOAST */
    .toast-fixed{
      position:fixed;
      top:20px;
      right:20px;
      z-index:9999;
    }
  </style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-custom">
  <div class="container d-flex justify-content-between align-items-center">
    <a class="navbar-brand">NOWFit Admin</a>
    <a href="/auth/logout" class="logout-btn"><i class="fa fa-sign-out-alt"></i> Logout</a>
  </div>
</nav>

<div class="container py-4">

  <!-- TITLE + ACTION BUTTONS -->
  <div class="d-flex justify-content-between align-items-start mb-3">

    <div>
      <h1 class="page-title">Users</h1>
      <p class="text-muted">Manage users, assign coaches, and view real-time app statistics.</p>
    </div>

    <div class="d-flex top-buttons">
      <a href="/admin/coaches" class="top-btn btn-coach me-2"><i class="fa fa-users"></i> Coaches</a>
      <a href="/admin/workouts" class="top-btn btn-workout me-2"><i class="fa fa-dumbbell"></i> Workouts</a>
      <a href="/admin/diets" class="top-btn btn-diet me-2"><i class="fa fa-apple-whole"></i> Diets</a>
      <a href="/admin/profile" class="top-btn btn-profile me-2"><i class="fa fa-user"></i> Profile</a>

      <button class="btn btn-create ms-3" data-bs-toggle="modal" data-bs-target="#createUserModal">
        + Create User
      </button>
    </div>
  </div>

  <!-- STATS -->
  <div class="stat-grid">
    <div class="stat-card"><h6>Total Users</h6><h2><%= stats.totalUsers %></h2></div>
    <div class="stat-card"><h6>Total Coaches</h6><h2><%= stats.totalCoaches %></h2></div>
    <div class="stat-card"><h6>Total Workouts</h6><h2><%= stats.totalWorkouts %></h2></div>
    <div class="stat-card"><h6>Total Diets</h6><h2><%= stats.totalDiets %></h2></div>
  </div>

  <!-- USERS TABLE -->
  <div class="table-card">
    <table id="usersTable" class="display table" style="width:100%;">
      <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Role</th>
        <th>Coach</th>
        <th style="width:230px">Actions</th>
      </tr>
      </thead>

      <tbody>
      <% users.forEach(u => { %>
        <tr data-id="<%= u._id %>">
          <td class="uname"><%= u.name %></td>
          <td class="uemail"><%= u.email %></td>
          <td><%= u.role %></td>
          <td class="ucoach"><%= u.coachAssigned ? u.coachAssigned.name : 'Not Assigned' %></td>
          <td>

            <button class="btn btn-sm btn-primary editBtn">
              <i class="fa fa-pen"></i>
            </button>

            <% if (!u.coachAssigned) { %>
              <button class="btn btn-sm btn-info text-white assignCoachBtn">
                <i class="fa fa-user-plus"></i>
              </button>
            <% } else { %>
              <button class="btn btn-sm btn-warning removeCoachBtn">
                <i class="fa fa-user-minus"></i>
              </button>
            <% } %>

            <button class="btn btn-sm btn-danger deleteBtn">
              <i class="fa fa-trash"></i>
            </button>

          </td>
        </tr>
      <% }) %>
      </tbody>

    </table>
  </div>

</div>

<!-- Toast Container -->
<div class="toast-fixed">
  <div id="flashToast" class="toast text-bg-success"></div>
</div>

<!-- CREATE USER MODAL -->
<div class="modal fade" id="createUserModal" tabindex="-1">
  <div class="modal-dialog modal-md">
    <form id="createUserForm" class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Create User / Coach</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3"><label>Name</label><input name="name" class="form-control" required></div>
        <div class="mb-3"><label>Email</label><input name="email" type="email" class="form-control" required></div>
        <div class="mb-3">
          <label>Role</label>
          <select name="role" class="form-select">
            <option value="user">User</option>
            <option value="coach">Coach</option>
          </select>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success">Create</button>
      </div>

    </form>
  </div>
</div>


<!-- EDIT USER MODAL -->
<div class="modal fade" id="editUserModal" tabindex="-1">
  <div class="modal-dialog modal-md">
    <form id="editUserForm" class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Edit User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="editUserId">
        <div class="mb-3"><label>Name</label><input id="editUserName" class="form-control"></div>
        <div class="mb-3"><label>Email</label><input id="editUserEmail" type="email" class="form-control"></div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary">Save</button>
      </div>

    </form>
  </div>
</div>


<!-- ASSIGN COACH MODAL -->
<div class="modal fade" id="assignCoachModal" tabindex="-1">
  <div class="modal-dialog modal-md">
    <form id="assignCoachForm" class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Assign Coach</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="assignUserId">
        <label>Select Coach</label>
        <select id="coachSelect" class="form-select"></select>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary">Assign</button>
      </div>

    </form>
  </div>
</div>


<!-- SCRIPTS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- FULL WORKING ADMIN JS -->
<script>
$(function(){

  const table = $('#usersTable').DataTable({ order: [] });

  function toast(msg, ok=true){
    let t = $('#flashToast');
    t.removeClass('text-bg-success text-bg-danger')
     .addClass(ok ? 'text-bg-success' : 'text-bg-danger')
     .text(msg)
     .fadeIn();
    setTimeout(()=> t.fadeOut(),1300);
  }

  // CREATE USER
  $('#createUserForm').on('submit', async function(e){
    e.preventDefault();

    const data = {
      name: this.name.value,
      email: this.email.value,
      role: this.role.value
    };

    const res = await fetch('/admin/users', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify(data)
    });

    const json = await res.json();

    if(json.success){
      toast('User Created');
      $('#createUserModal').modal('hide');
      setTimeout(()=> location.reload(),900);
    } else {
      toast(json.message || 'Failed', false);
    }
  });

  // OPEN EDIT MODAL
  $('#usersTable').on('click', '.editBtn', function(){
    const tr = $(this).closest('tr');
    $('#editUserId').val(tr.data('id'));
    $('#editUserName').val(tr.find('.uname').text());
    $('#editUserEmail').val(tr.find('.uemail').text());
    $('#editUserModal').modal('show');
  });

  // SAVE EDIT
  $('#editUserForm').on('submit', async function(e){
    e.preventDefault();

    const id = $('#editUserId').val();
    const data = {
      name: $('#editUserName').val(),
      email: $('#editUserEmail').val()
    };

    const res = await fetch('/admin/users/'+id, {
      method:'PUT',
      headers:{'content-type':'application/json'},
      body: JSON.stringify(data)
    });

    const json = await res.json();

    if(json.success){
      toast('Updated');
      $('#editUserModal').modal('hide');
      setTimeout(()=> location.reload(),900);
    } else toast('Failed', false);
  });

  // DELETE USER
  $('#usersTable').on('click', '.deleteBtn', async function(){
    if(!confirm('Delete user?')) return;

    const id = $(this).closest('tr').data('id');
    await fetch('/admin/users/'+id, { method:'DELETE' });

    toast('Deleted');
    setTimeout(()=> location.reload(),700);
  });

  // OPEN ASSIGN COACH MODAL
  $('#usersTable').on('click', '.assignCoachBtn', async function(){
    const userId = $(this).closest('tr').data('id');
    $('#assignUserId').val(userId);

    const res = await fetch('/admin/coaches-data');
    const json = await res.json();

    $('#coachSelect').empty();
    json.coaches.forEach(c=>{
      $('#coachSelect').append(`<option value="${c._id}">${c.name} (${c.email})</option>`);
    });

    $('#assignCoachModal').modal('show');
  });

  // SUBMIT ASSIGN COACH
  $('#assignCoachForm').on('submit', async function(e){
    e.preventDefault();

    const userId = $('#assignUserId').val();
    const coachId = $('#coachSelect').val();

    const res = await fetch(`/admin/users/${userId}/assign-coach`, {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ coachId })
    });

    const json = await res.json();

    if(json.success){
      toast('Coach Assigned');
      $('#assignCoachModal').modal('hide');
      setTimeout(()=> location.reload(),700);
    }
    else toast('Failed', false);
  });

  // REMOVE COACH
  $('#usersTable').on('click', '.removeCoachBtn', async function(){
    if(!confirm('Remove coach?')) return;

    const id = $(this).closest('tr').data('id');

    const res = await fetch(`/admin/users/${id}/remove-coach`, {
      method:'POST'
    });

    const json = await res.json();

    if(json.success){
      toast('Coach Removed');
      setTimeout(()=> location.reload(),700);
    }
    else toast('Failed', false);
  });

});
</script>

</body>
</html>
