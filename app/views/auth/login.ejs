<!doctype html>
<html>
<head>
  <title>Login – NOWFit</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="icon" type="image/png" href="/favicon.png">

  <style>
    body { background:#eef2f7; }
    .card-box {
      max-width:450px;
      margin:auto;
      margin-top:80px;
      background:white;
      padding:30px;
      border-radius:14px;
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
    }
    /* Toast */
    #toastMsg {
      position:fixed;
      top:20px;
      right:20px;
      padding:12px 20px;
      border-radius:8px;
      z-index:99999;
      font-weight:600;
      display:none;
      color:white;
    }
  </style>
</head>

<body>

<!-- TOAST -->
<div id="toastMsg"></div>

<div class="card-box">

  <h2 class="text-center mb-3">NOWFit Login</h2>
  <p class="text-center text-muted mb-4">Access your account</p>

  <% if(typeof error !== 'undefined'){ %>
    <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <form method="post" action="/auth/login">

    <div class="mb-3">
      <label>Email</label>
      <input required type="email" name="email" class="form-control"/>
    </div>

    <div class="mb-3">
      <label>Password</label>
      <input required type="password" name="password" class="form-control"/>
    </div>

    <button class="btn btn-primary w-100 mb-2">Login</button>

    <div class="d-flex justify-content-between mt-2">
      <a href="/auth/register" class="btn btn-secondary">Register</a>
      <button type="button" id="openForgot" class="btn btn-warning">Forgot Password?</button>
    </div>

  </form>

</div>

<!-- ==================== FORGOT PASSWORD MODAL =================== -->
<div class="modal fade" id="forgotModal" tabindex="-1">
  <div class="modal-dialog modal-md">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Reset Password (OTP)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- Step 1: Email -->
        <div id="stepEmail">
          <label>Enter your email</label>
          <input id="fp_email" type="email" class="form-control mb-3" placeholder="Email">
          <button id="sendOtpBtn" class="btn btn-success w-100">Send OTP</button>
        </div>

        <!-- Step 2: OTP + New Password -->
        <div id="stepOtp" style="display:none;">
          <label>Enter OTP</label>
          <input id="fp_otp" class="form-control mb-3" placeholder="OTP">

          <label>New Password</label>
          <input id="fp_newpass" type="password" class="form-control mb-3" placeholder="New Password">

          <button id="resetPassBtn" class="btn btn-primary w-100">Reset Password</button>
        </div>

      </div>

    </div>
  </div>
</div>


<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>

// Toast function
function toast(msg, success=true){
  const t = $("#toastMsg");
  t.css("background", success ? "#10b981" : "#ef4444");
  t.text(msg).fadeIn(200);
  setTimeout(()=> t.fadeOut(300), 1800);
}

// Open modal
$("#openForgot").click(()=>{
  $("#forgotModal").modal("show");
});

// Send OTP
$("#sendOtpBtn").click(async () => {
  const email = $("#fp_email").val().trim();
  if(!email) return toast("Enter email", false);

  const res = await fetch("/auth/send-otp",{
    method:"POST",
    headers:{ "content-type":"application/json" },
    body:JSON.stringify({ email })
  });

  const json = await res.json();
  toast(json.message, json.success);

  // If OTP sent → show next step
  if(json.success){
    $("#stepEmail").hide();
    $("#stepOtp").show();
  }
});

// Reset password
$("#resetPassBtn").click(async () => {
  const otp = $("#fp_otp").val().trim();
  const newPassword = $("#fp_newpass").val().trim();
  const email = $("#fp_email").val().trim();

  if(!otp || !newPassword) return toast("Fill all fields", false);

  const res = await fetch("/auth/reset-password",{
    method:"POST",
    headers:{ "content-type":"application/json" },
    body:JSON.stringify({ email, otp, newPassword })
  });

  const json = await res.json();
  toast(json.message, json.success);

  if(json.success){
    setTimeout(()=> location.reload(), 1200);
  }
});
</script>

</body>
</html>
