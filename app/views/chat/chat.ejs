<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
<link rel="icon" type="image/png" href="/favicon.png">

    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f4f6f9;
            font-family: Inter, Arial;
        }

        #messages {
            height: 70vh;
            overflow-y: auto;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            margin-bottom: 15px;
        }

        .msg-row {
            margin-bottom: 10px;
            display: flex;
            width: 100%;
        }

        .me { justify-content: flex-end; }
        .them { justify-content: flex-start; }

        .bubble {
            max-width: 60%;
            padding: 10px 16px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.3;
        }

        .bubble-me {
            background: #0ea5a4;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .bubble-them {
            background: #e5e5e5;
            color: #111;
            border-bottom-left-radius: 4px;
        }

        /* Status bar */
        .status-box {
            font-size: 14px;
            margin-left: 8px;
            color: #6b7280;
        }

        .typing {
            font-size: 13px;
            color: #0ea5a4;
            margin-top: -5px;
        }

        .online-dot {
            width: 10px;
            height: 10px;
            background: #10b981;
            border-radius: 50%;
            display: inline-block;
        }

        .offline-dot {
            width: 10px;
            height: 10px;
            background: #9ca3af;
            border-radius: 50%;
            display: inline-block;
        }
    </style>
</head>

<body class="container py-4">

    <!-- HEADER -->
    <h3 class="chat-header d-flex align-items-center">
        Chat with <%= receiver.name %>

        &nbsp;Â·&nbsp;

        <!-- ONLINE / OFFLINE STATUS -->
        <span id="online-status">
            <span class="offline-dot"></span>
            Offline
        </span>
    </h3>

    <div id="typingStatus" class="typing"></div>

    <!-- MESSAGE BOX -->
    <div id="messages">
        <% messages.forEach(m => { %>

            <div class="msg-row <%= m.from.toString() === user._id.toString() ? 'me' : 'them' %>">
                <div class="bubble <%= m.from.toString() === user._id.toString() ? 'bubble-me' : 'bubble-them' %>">
                    <%= m.message %>
                </div>
            </div>

        <% }) %>
    </div>

    <!-- INPUT -->
    <div class="input-group">
        <input id="msg" class="form-control" placeholder="Type message...">
        <button id="sendBtn" class="btn btn-primary">Send</button>
    </div>


<script>
const socket = io();

// CURRENT USER
const userId = "<%= user._id %>";
const receiverId = "<%= receiver._id %>";

// REGISTER USER AS ONLINE
socket.emit("registerUser", userId);

// JOIN ROOM
socket.emit("joinRoom", { userId, receiverId });

// AUTO SCROLL FUNCTION
function scrollToBottom() {
    const box = document.getElementById("messages");
    box.scrollTop = box.scrollHeight;
}
scrollToBottom();


// ===============================
// ONLINE / OFFLINE STATUS
// ===============================
socket.on("onlineStatus", ({ userId: uid, status }) => {
    if (uid === receiverId) {
        const box = document.getElementById("online-status");

        if (status === "online") {
            box.innerHTML = `<span class="online-dot"></span> Online`;
        } else {
            box.innerHTML = `<span class="offline-dot"></span> Offline`;
        }
    }
});


// ===============================
// TYPING INDICATOR
// ===============================
const typingBox = document.getElementById("typingStatus");
let typingTimeout;

document.getElementById("msg").addEventListener("input", () => {
    socket.emit("typing", { from: userId, to: receiverId });

    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        socket.emit("stopTyping", { from: userId, to: receiverId });
    }, 1200);
});

socket.on("typing", ({ from }) => {
    if (from === receiverId) typingBox.textContent = "Typing...";
});

socket.on("stopTyping", ({ from }) => {
    if (from === receiverId) typingBox.textContent = "";
});


// ===============================
// RECEIVE MESSAGE
// ===============================
socket.on("receiveMessage", data => {
    const box = document.getElementById("messages");
    const isMe = data.sender === userId;

    box.innerHTML += `
        <div class="msg-row ${isMe ? 'me' : 'them'}">
            <div class="bubble ${isMe ? 'bubble-me' : 'bubble-them'}">
                ${data.message}
            </div>
        </div>
    `;

    scrollToBottom();
});


// ===============================
// SEND MESSAGE
// ===============================
document.getElementById("sendBtn").onclick = sendMsg;
document.getElementById("msg").addEventListener("keyup", (e) => {
    if (e.key === "Enter") sendMsg();
});

function sendMsg() {
    const input = document.getElementById("msg");
    const message = input.value.trim();
    if (!message) return;

    socket.emit("sendMessage", {
        sender: userId,
        receiver: receiverId,
        message
    });

    input.value = "";
}
</script>

</body>
</html>
